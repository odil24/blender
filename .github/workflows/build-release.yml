name: Build Blender Windows (Ninja + sccache)

on:
  push:
    branches: [ main ]  # or your default branch
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      BLENDER_SRC_DIR: ${{ github.workspace }}/blender
      LIB_DIR: ${{ github.workspace }}/lib
      BUILD_DIR: ${{ github.workspace }}/build_windows_ninja

    steps:
    - name: Checkout Blender Source
      uses: actions/checkout@v4
      with:
        path: blender
        submodules: false

    - name: Install Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v2

    - name: Install CMake
      uses: lukka/get-cmake@latest

    - name: Install Ninja and sccache
      run: |
        choco install ninja sccache -y
      shell: pwsh

    - name: Add sccache to PATH
      run: |
        echo "${env:ProgramFiles}\sccache" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8
      shell: pwsh

    - name: Download Blender Libraries
      working-directory: ${{ env.BLENDER_SRC_DIR }}
      run: |
        python ./build_files/cmake/Modules/Setup/SetupBlenderLibraries.py --source-dir . --lib-dir "${env:LIB_DIR}" --config release
      shell: pwsh

    - name: Configure with CMake (Ninja + sccache + developer options)
      run: |
        cmake -S "${env:BLENDER_SRC_DIR}" -B "${env:BUILD_DIR}" ^
          -G Ninja ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DWITH_INSTALL_PORTABLE=ON ^
          -DCMAKE_C_COMPILER_LAUNCHER=sccache ^
          -DCMAKE_CXX_COMPILER_LAUNCHER=sccache ^
          -C "${env:BLENDER_SRC_DIR}/build_files/cmake/config/blender_developer.cmake"
      shell: cmd

    - name: Build Blender (INSTALL target)
      run: |
        cmake --build "${env:BUILD_DIR}" --target INSTALL -j
      shell: cmd

    - name: Upload Blender Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: blender-windows-ninja-build
        path: ${{ env.BUILD_DIR }}/bin/
        if-no-files-found: error
