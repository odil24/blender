name: Build Blender Windows Release

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Тип сборки"
        required: true
        default: "Release"
        type: choice
        options:
          - Release
          - Debug

  push:
    tags:
      - "v4.5.*"
      - "v5.0.*"

  # schedule:
  #   - cron: "0 3 * * *"

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      BLENDER_BUILD_CONFIG: ${{ github.event.inputs.build_type || 'Release' }}
      BUILD_DIR: build_windows_x64
      BLENDER_FORCE_YES: 1
      FORCE_YES: 1

    steps:
      # ---- Checkout ----
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Git LFS Init
        run: git lfs install

      # ---- Cache Blender Libraries ----
      - name: Cache Libraries Download
        id: blender_lib_cache
        uses: actions/cache@v4
        with:
          path: ./lib
          key: blender-libs-${{ runner.os }}-${{ hashFiles('build_files/**/*') }}

      # ---- auto-yes update ----
      - name: Update Sources & Libraries
        if: steps.blender_lib_cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo y | call make.bat update

      # ---- CUDA (Blender autodetects) ----
      - name: CUDA Prepare
        shell: cmd
        run: |
          echo Auto-detection of CUDA/OptiX enabled

      # ---- Build ----
      - name: Build Blender
        shell: cmd
        run: |
          echo y | call make.bat %BLENDER_BUILD_CONFIG%

      - name: Verify Output
        shell: cmd
        run: |
          echo Checking output directory...
          dir %BUILD_DIR%\bin\%BLENDER_BUILD_CONFIG%

      # ---- ZIP ----
      - name: Create Release ZIP
        shell: powershell
        run: |
          $zipName = "blender-${{ env.BLENDER_BUILD_CONFIG }}.zip"
          Compress-Archive -Path "$env:BUILD_DIR\bin\${{ env.BLENDER_BUILD_CONFIG }}\*" -DestinationPath $zipName
          Write-Output "ZIP created: $zipName"

      # ---- Portable ----
      - name: Create Portable Build
        shell: powershell
        run: |
          $folder = "blender-portable"
          New-Item -ItemType Directory -Path $folder
          Copy-Item "$env:BUILD_DIR\bin\${{ env.BLENDER_BUILD_CONFIG }}\*" -Destination $folder -Recurse
          $zipPortable = "blender-portable-${{ env.BLENDER_BUILD_CONFIG }}.zip"
          Compress-Archive -Path "$folder\*" -DestinationPath $zipPortable
          Write-Output "Portable ZIP: $zipPortable"

      # ---- Upload ----
      - name: Upload Build ZIP
        uses: actions/upload-artifact@v4
        with:
          name: blender-windows-${{ env.BLENDER_BUILD_CONFIG }}
          path: blender-${{ env.BLENDER_BUILD_CONFIG }}.zip

      - name: Upload Portable
        uses: actions/upload-artifact@v4
        with:
          name: blender-windows-portable-${{ env.BLENDER_BUILD_CONFIG }}
          path: blender-portable-${{ env.BLENDER_BUILD_CONFIG }}.zip


  # ---- AUTO RELEASE ----
  publish-release:
    needs: build-windows
    if: |
      startsWith(github.ref, 'refs/tags/v4.5.') ||
      startsWith(github.ref, 'refs/tags/v5.0.')
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/**/*
