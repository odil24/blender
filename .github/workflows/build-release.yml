name: Build Blender Windows Release

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Тип сборки"
        required: true
        default: "Release"
        type: choice
        options:
          - Release
          - Debug

  # Авто-триггер по тегам ТОЛЬКО для 4.5.x и 5.0.x
  push:
    tags:
      - "v4.5.*"
      - "v5.0.*"

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      BLENDER_BUILD_CONFIG: ${{ github.event.inputs.build_type || 'Release' }}
      BUILD_DIR: build_windows_x64

    steps:
      # ---- Checkout ----
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Git LFS Init
        run: git lfs install

      # ---- Cache Blender Libraries ----
      - name: Cache Libraries Download
        id: blender_lib_cache
        uses: actions/cache@v4
        with:
          path: ./lib
          key: blender-libs-${{ runner.os }}-${{ hashFiles('build_files/**/*') }}

      # ---- Update Sources & Libraries (auto-download) ----
      - name: Update Sources & Libraries
        if: steps.blender_lib_cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo Auto-download enabled
          set BLENDER_SKIP_CONFIRMATION=1
          set FORCE_YES=1
          set BLENDER_FORCE_DOWNLOAD=1
          call make.bat update

      # ---- Build Blender ----
      - name: Build Blender
        shell: cmd
        run: |
          call make.bat blender

      # ---- Verify Output ----
      - name: Verify Output
        shell: cmd
        run: |
          dir %BUILD_DIR%\bin\%BLENDER_BUILD_CONFIG%

      # ---- Create Release ZIP ----
      - name: Create Release ZIP
        shell: powershell
        run: |
          $zipName = "blender-${{ env.BLENDER_BUILD_CONFIG }}.zip"
          Compress-Archive -Path "$env:BUILD_DIR\bin\${{ env.BLENDER_BUILD_CONFIG }}\*" -DestinationPath $zipName
          echo "ZIP created: $zipName"

      # ---- Create Portable ZIP ----
      - name: Create Portable Version
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path blender-portable
          Copy-Item "$env:BUILD_DIR\bin\${{ env.BLENDER_BUILD_CONFIG }}\*" -Destination blender-portable -Recurse
          $zipPortable = "blender-portable-${{ env.BLENDER_BUILD_CONFIG }}.zip"
          Compress-Archive -Path "blender-portable\*" -DestinationPath $zipPortable
          echo "Portable ZIP: $zipPortable"

      # ---- Upload artifacts ----
      - name: Upload Release ZIP
        uses: actions/upload-artifact@v4
        with:
          name: blender-windows-${{ env.BLENDER_BUILD_CONFIG }}
          path: blender-${{ env.BLENDER_BUILD_CONFIG }}.zip

      - name: Upload Portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: blender-windows-portable-${{ env.BLENDER_BUILD_CONFIG }}
          path: blender-portable-${{ env.BLENDER_BUILD_CONFIG }}.zip

  # ---- Job для авто-релиза ----
  publish-release:
    needs: build-windows
    if: |
      startsWith(github.ref, 'refs/tags/v4.5.') ||
      startsWith(github.ref, 'refs/tags/v5.0.')
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/**/*
